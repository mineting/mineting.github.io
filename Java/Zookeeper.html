<!doctype html>
<html lang="en-US" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.67" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://vuepress-theme-hope-docs-MineTing.netlify.app/Java/Zookeeper.html"><meta property="og:site_name" content="Docs Demo"><meta property="og:title" content="Zookeeper"><meta property="og:description" content="Zookeeper 简介 Zookeeper 是一个开源的分布式的，为分布式框架提供协调服务的 Apache 项目。 官网：https://zookeeper.apache.org/ Zookeeper 工作机制 ​		是一个基于观察者模式设计的分布式服务管理框架，它负责存储和管理大家都关心的数据，然后接受观察者的注册，一旦这些数据的状态发生变化，Zo..."><meta property="og:type" content="article"><meta property="og:image" content="https://vuepress-theme-hope-docs-MineTing.netlify.app/"><meta property="og:locale" content="en-US"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image:alt" content="Zookeeper"><meta property="article:author" content="MineTing"><meta property="article:published_time" content="2023-03-16T00:00:00.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Zookeeper","image":["https://vuepress-theme-hope-docs-MineTing.netlify.app/"],"datePublished":"2023-03-16T00:00:00.000Z","dateModified":null,"author":[{"@type":"Person","name":"MineTing"}]}</script><title>Zookeeper | Docs Demo</title><meta name="description" content="Zookeeper 简介 Zookeeper 是一个开源的分布式的，为分布式框架提供协调服务的 Apache 项目。 官网：https://zookeeper.apache.org/ Zookeeper 工作机制 ​		是一个基于观察者模式设计的分布式服务管理框架，它负责存储和管理大家都关心的数据，然后接受观察者的注册，一旦这些数据的状态发生变化，Zo...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-d97197b4.css" as="style"><link rel="stylesheet" href="/assets/style-d97197b4.css">
    <link rel="modulepreload" href="/assets/app-ae2ce5af.js"><link rel="modulepreload" href="/assets/Zookeeper.html-796b6238.js"><link rel="modulepreload" href="/assets/Zookeeper.html-5d8329d4.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js"><link rel="prefetch" href="/assets/slides.html-d4b68ae3.js" as="script"><link rel="prefetch" href="/assets/MySQL.html-2c3189d9.js" as="script"><link rel="prefetch" href="/assets/Oracle.html-1ddfb32a.js" as="script"><link rel="prefetch" href="/assets/PostgreSQL.html-8d7c3b11.js" as="script"><link rel="prefetch" href="/assets/Redis.html-1871171c.js" as="script"><link rel="prefetch" href="/assets/ActiveMQ.html-7e36c817.js" as="script"><link rel="prefetch" href="/assets/Dubbo.html-a8cd7449.js" as="script"><link rel="prefetch" href="/assets/Effective Java.html-dfcd6599.js" as="script"><link rel="prefetch" href="/assets/Elasticsearch.html-e5846d2c.js" as="script"><link rel="prefetch" href="/assets/Gis.html-ddd37e0c.js" as="script"><link rel="prefetch" href="/assets/Git-Svn.html-af5d4a81.js" as="script"><link rel="prefetch" href="/assets/Http.html-8daf18da.js" as="script"><link rel="prefetch" href="/assets/Interview.html-1b10aa33.js" as="script"><link rel="prefetch" href="/assets/JavaSE.html-9f047d15.js" as="script"><link rel="prefetch" href="/assets/JavaWeb.html-cb212caf.js" as="script"><link rel="prefetch" href="/assets/JVM.html-f072d845.js" as="script"><link rel="prefetch" href="/assets/Kafka.html-25bd84a0.js" as="script"><link rel="prefetch" href="/assets/Maven-Gradle.html-d83ac95f.js" as="script"><link rel="prefetch" href="/assets/Mybatis.html-885e6e8d.js" as="script"><link rel="prefetch" href="/assets/MybatisPlus.html-598dfbea.js" as="script"><link rel="prefetch" href="/assets/Netty.html-8c02d0e8.js" as="script"><link rel="prefetch" href="/assets/Nginx.html-5aa9d1fb.js" as="script"><link rel="prefetch" href="/assets/RabbitMQ.html-0d6d977e.js" as="script"><link rel="prefetch" href="/assets/RocketMQ.html-49e403fa.js" as="script"><link rel="prefetch" href="/assets/ServerLess.html-e22cee80.js" as="script"><link rel="prefetch" href="/assets/Shiro.html-5d17df5c.js" as="script"><link rel="prefetch" href="/assets/Spring.html-97965d72.js" as="script"><link rel="prefetch" href="/assets/SpringBoot2.html-c86a37b5.js" as="script"><link rel="prefetch" href="/assets/SpringCloud.html-9a245adc.js" as="script"><link rel="prefetch" href="/assets/SpringMVC.html-0cc84083.js" as="script"><link rel="prefetch" href="/assets/SpringSecurity.html-f1ecb2f4.js" as="script"><link rel="prefetch" href="/assets/多线程与并发编程.html-db7a7ee6.js" as="script"><link rel="prefetch" href="/assets/常见场景实现.html-45d3f82e.js" as="script"><link rel="prefetch" href="/assets/操作系统.html-4f78fb7f.js" as="script"><link rel="prefetch" href="/assets/数据结构与算法.html-08698f6d.js" as="script"><link rel="prefetch" href="/assets/计算机网络.html-b52dc063.js" as="script"><link rel="prefetch" href="/assets/设计模式.html-21d367ac.js" as="script"><link rel="prefetch" href="/assets/Basic.html-2e318635.js" as="script"><link rel="prefetch" href="/assets/Docker.html-25a77026.js" as="script"><link rel="prefetch" href="/assets/KubeSphere.html-9567c249.js" as="script"><link rel="prefetch" href="/assets/Python.html-1e966dd9.js" as="script"><link rel="prefetch" href="/assets/HtmlCSS.html-7dd20864.js" as="script"><link rel="prefetch" href="/assets/JavaScript.html-7c696a30.js" as="script"><link rel="prefetch" href="/assets/jQuery.html-2a1066fa.js" as="script"><link rel="prefetch" href="/assets/React.html-5412a153.js" as="script"><link rel="prefetch" href="/assets/Vue.html-85fe9f9e.js" as="script"><link rel="prefetch" href="/assets/index.html-67b15fdc.js" as="script"><link rel="prefetch" href="/assets/slides.html-8c03d836.js" as="script"><link rel="prefetch" href="/assets/Notifition.html-ac544339.js" as="script"><link rel="prefetch" href="/assets/disable.html-2dea8664.js" as="script"><link rel="prefetch" href="/assets/encrypt.html-abf55e88.js" as="script"><link rel="prefetch" href="/assets/markdown.html-175f2004.js" as="script"><link rel="prefetch" href="/assets/page.html-0e44d074.js" as="script"><link rel="prefetch" href="/assets/index.html-a29f879c.js" as="script"><link rel="prefetch" href="/assets/index.html-b73e550e.js" as="script"><link rel="prefetch" href="/assets/baz.html-2cb41f02.js" as="script"><link rel="prefetch" href="/assets/index.html-969443a6.js" as="script"><link rel="prefetch" href="/assets/ray.html-62ce5fc6.js" as="script"><link rel="prefetch" href="/assets/index.html-9b626ed8.js" as="script"><link rel="prefetch" href="/assets/404.html-9df708ff.js" as="script"><link rel="prefetch" href="/assets/index.html-f1ef565e.js" as="script"><link rel="prefetch" href="/assets/index.html-7dc05b06.js" as="script"><link rel="prefetch" href="/assets/index.html-94fd5f7d.js" as="script"><link rel="prefetch" href="/assets/index.html-c580c463.js" as="script"><link rel="prefetch" href="/assets/index.html-2e8ee3a7.js" as="script"><link rel="prefetch" href="/assets/index.html-bc51f108.js" as="script"><link rel="prefetch" href="/assets/index.html-de8bd102.js" as="script"><link rel="prefetch" href="/assets/slides.html-35427f3a.js" as="script"><link rel="prefetch" href="/assets/MySQL.html-b4c05c5f.js" as="script"><link rel="prefetch" href="/assets/Oracle.html-31a22ec5.js" as="script"><link rel="prefetch" href="/assets/PostgreSQL.html-4b3a9fee.js" as="script"><link rel="prefetch" href="/assets/Redis.html-5593bcac.js" as="script"><link rel="prefetch" href="/assets/ActiveMQ.html-17e2f150.js" as="script"><link rel="prefetch" href="/assets/Dubbo.html-f1ccf506.js" as="script"><link rel="prefetch" href="/assets/Effective Java.html-611a5b80.js" as="script"><link rel="prefetch" href="/assets/Elasticsearch.html-6a52bfc3.js" as="script"><link rel="prefetch" href="/assets/Gis.html-8abfec19.js" as="script"><link rel="prefetch" href="/assets/Git-Svn.html-52d9c4f5.js" as="script"><link rel="prefetch" href="/assets/Http.html-be7a915b.js" as="script"><link rel="prefetch" href="/assets/Interview.html-e7be77bf.js" as="script"><link rel="prefetch" href="/assets/JavaSE.html-0e3b628d.js" as="script"><link rel="prefetch" href="/assets/JavaWeb.html-41d4b249.js" as="script"><link rel="prefetch" href="/assets/JVM.html-dbd72723.js" as="script"><link rel="prefetch" href="/assets/Kafka.html-944c972c.js" as="script"><link rel="prefetch" href="/assets/Maven-Gradle.html-d8008567.js" as="script"><link rel="prefetch" href="/assets/Mybatis.html-ce0c0db3.js" as="script"><link rel="prefetch" href="/assets/MybatisPlus.html-2c5b8712.js" as="script"><link rel="prefetch" href="/assets/Netty.html-d9e9600f.js" as="script"><link rel="prefetch" href="/assets/Nginx.html-98042356.js" as="script"><link rel="prefetch" href="/assets/RabbitMQ.html-789fcfb2.js" as="script"><link rel="prefetch" href="/assets/RocketMQ.html-076b5dec.js" as="script"><link rel="prefetch" href="/assets/ServerLess.html-0737dc3b.js" as="script"><link rel="prefetch" href="/assets/Shiro.html-e3093d4f.js" as="script"><link rel="prefetch" href="/assets/Spring.html-2ac4675c.js" as="script"><link rel="prefetch" href="/assets/SpringBoot2.html-7ab29a5b.js" as="script"><link rel="prefetch" href="/assets/SpringCloud.html-05fe7030.js" as="script"><link rel="prefetch" href="/assets/SpringMVC.html-748abb3f.js" as="script"><link rel="prefetch" href="/assets/SpringSecurity.html-e9f6acd6.js" as="script"><link rel="prefetch" href="/assets/多线程与并发编程.html-f6dbec75.js" as="script"><link rel="prefetch" href="/assets/常见场景实现.html-8f6b3fa9.js" as="script"><link rel="prefetch" href="/assets/操作系统.html-5bc15ff2.js" as="script"><link rel="prefetch" href="/assets/数据结构与算法.html-3c552842.js" as="script"><link rel="prefetch" href="/assets/计算机网络.html-1a1a87f0.js" as="script"><link rel="prefetch" href="/assets/设计模式.html-5c7c95ef.js" as="script"><link rel="prefetch" href="/assets/Basic.html-a2d2fe60.js" as="script"><link rel="prefetch" href="/assets/Docker.html-6d4eaef8.js" as="script"><link rel="prefetch" href="/assets/KubeSphere.html-3728deb9.js" as="script"><link rel="prefetch" href="/assets/Python.html-347ee1e7.js" as="script"><link rel="prefetch" href="/assets/HtmlCSS.html-fc50e4d3.js" as="script"><link rel="prefetch" href="/assets/JavaScript.html-b05d397f.js" as="script"><link rel="prefetch" href="/assets/jQuery.html-1c4e954d.js" as="script"><link rel="prefetch" href="/assets/React.html-d9b1e002.js" as="script"><link rel="prefetch" href="/assets/Vue.html-0b3d4dd9.js" as="script"><link rel="prefetch" href="/assets/index.html-acb676ad.js" as="script"><link rel="prefetch" href="/assets/slides.html-40da5346.js" as="script"><link rel="prefetch" href="/assets/Notifition.html-42cb38d5.js" as="script"><link rel="prefetch" href="/assets/disable.html-3b8c1244.js" as="script"><link rel="prefetch" href="/assets/encrypt.html-57f5861e.js" as="script"><link rel="prefetch" href="/assets/markdown.html-a2e16149.js" as="script"><link rel="prefetch" href="/assets/page.html-fee4dd0d.js" as="script"><link rel="prefetch" href="/assets/index.html-a5e39405.js" as="script"><link rel="prefetch" href="/assets/index.html-a7c9ad07.js" as="script"><link rel="prefetch" href="/assets/baz.html-e3cf3d89.js" as="script"><link rel="prefetch" href="/assets/index.html-b7cc2189.js" as="script"><link rel="prefetch" href="/assets/ray.html-295aa4c2.js" as="script"><link rel="prefetch" href="/assets/index.html-cc65b46d.js" as="script"><link rel="prefetch" href="/assets/404.html-3ea6dd0d.js" as="script"><link rel="prefetch" href="/assets/index.html-df589b5a.js" as="script"><link rel="prefetch" href="/assets/index.html-fe03f011.js" as="script"><link rel="prefetch" href="/assets/index.html-0a3b162f.js" as="script"><link rel="prefetch" href="/assets/index.html-f0a5ac48.js" as="script"><link rel="prefetch" href="/assets/index.html-37711430.js" as="script"><link rel="prefetch" href="/assets/index.html-68e0b571.js" as="script"><link rel="prefetch" href="/assets/index.html-2c257328.js" as="script"><link rel="prefetch" href="/assets/auto-fe80bb03.js" as="script"><link rel="prefetch" href="/assets/index-2bf332f6.js" as="script"><link rel="prefetch" href="/assets/flowchart-c441f34d.js" as="script"><link rel="prefetch" href="/assets/mermaid.core-e67e6523.js" as="script"><link rel="prefetch" href="/assets/highlight.esm-75b11b9d.js" as="script"><link rel="prefetch" href="/assets/markdown.esm-abe06b83.js" as="script"><link rel="prefetch" href="/assets/math.esm-70a288c8.js" as="script"><link rel="prefetch" href="/assets/notes.esm-a106bb2c.js" as="script"><link rel="prefetch" href="/assets/reveal.esm-ec5549c1.js" as="script"><link rel="prefetch" href="/assets/search.esm-7e6792e2.js" as="script"><link rel="prefetch" href="/assets/zoom.esm-b83b91d0.js" as="script"><link rel="prefetch" href="/assets/VuePlayground-0382da01.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-5794cde2.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">Skip to main content</a><!--]--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand" href="/"><img class="vp-nav-logo" src="/logo.svg" alt="Docs Demo"><!----><span class="vp-site-name hide-in-pad">MineTing</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><!----><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><div class="nav-item"><div class="dropdown-wrapper i18n-dropdown"><button type="button" class="dropdown-title" aria-label="Select language"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon i18n-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="i18n icon" style="width:1rem;height:1rem;vertical-align:middle;"><path d="M379.392 460.8 494.08 575.488l-42.496 102.4L307.2 532.48 138.24 701.44l-71.68-72.704L234.496 460.8l-45.056-45.056c-27.136-27.136-51.2-66.56-66.56-108.544h112.64c7.68 14.336 16.896 27.136 26.112 35.84l45.568 46.08 45.056-45.056C382.976 312.32 409.6 247.808 409.6 204.8H0V102.4h256V0h102.4v102.4h256v102.4H512c0 70.144-37.888 161.28-87.04 210.944L378.88 460.8zM576 870.4 512 1024H409.6l256-614.4H768l256 614.4H921.6l-64-153.6H576zM618.496 768h196.608L716.8 532.48 618.496 768z"></path></svg><!--]--><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a class="vp-link nav-link active" href="/Java/Zookeeper.html"><!---->English<!----></a></li><li class="dropdown-item"><a class="vp-link nav-link" href="/zh/"><!---->简体中文<!----></a></li></ul></button></div></div><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/vuepress-theme-hope/vuepress-theme-hope" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" class="outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><!----><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/slides.html"><span class="font-icon icon fa-fw fa-sm fas fa-person-chalkboard" style=""></span>Slide page<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable active" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">Java</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/Java/Kafka.html"><!---->Kafka<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/Java/JavaSE.html"><!---->JavaSE<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/Java/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95.html"><!---->复杂度分析<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/Java/Algorithms.html"><!---->/Java/Algorithms.md<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/Java/DesignPattern.html"><!---->/Java/DesignPattern.md<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/Java/ConcurrentProgramming.html"><!---->/Java/ConcurrentProgramming.md<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/Java/Netty.html"><!---->Netty<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/Java/JVM.html"><!---->JVM<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/Java/JavaWeb.html"><!---->JavaWeb<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/Java/Spring.html"><!---->Spring<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/Java/SpringMVC.html"><!---->SpringMVC<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/Java/Mybatis.html"><!---->Mybatis<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/Java/MybatisPlus.html"><!---->MybatisPlus<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/Java/Shiro.html"><!---->Shiro<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/Java/SpringSecurity.html"><!---->SpringSecurity<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/Java/SpringBoot.html"><!---->/Java/SpringBoot.md<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/Java/Redis.html"><!---->/Java/Redis.md<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link active vp-sidebar-link vp-sidebar-page active" href="/Java/Zookeeper.html"><!---->Zookeeper<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#简介"><!---->简介<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#zookeeper-工作机制"><!---->Zookeeper 工作机制<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#zookeeper-特点"><!---->Zookeeper 特点<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#数据结构"><!---->数据结构<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#应用场景"><!---->应用场景<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#统一命名服务"><!---->统一命名服务<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#统一配置管理"><!---->统一配置管理<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#统一集群管理"><!---->统一集群管理<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#服务器动态上下线"><!---->服务器动态上下线<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#软负载均衡"><!---->软负载均衡<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#安装说明"><!---->安装说明<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#配置参数解读"><!---->配置参数解读<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#集群安装"><!---->集群安装<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#选举机制"><!---->选举机制<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#第一次启动"><!---->第一次启动<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#非第一次启动"><!---->非第一次启动<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#客户端命令行操作"><!---->客户端命令行操作<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#基本语法"><!---->基本语法<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#znode-节点数据信息"><!---->znode 节点数据信息<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#节点类型-持久-短暂-有序号-无序号"><!---->节点类型（持久/短暂/有序号/无序号）<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#监听器原理"><!---->监听器原理<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#节点删除与查看"><!---->节点删除与查看<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#客户端-api-操作"><!---->客户端 API 操作<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#创建工程"><!---->创建工程<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#创建-zookeeper-客户端"><!---->创建 ZooKeeper 客户端<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#创建节点"><!---->创建节点<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#监听子节点变化"><!---->监听子节点变化<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#判断节点是否存在"><!---->判断节点是否存在<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#客户端向服务端写数据流程"><!---->客户端向服务端写数据流程<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#写入请求直接发送给leader节点"><!---->写入请求直接发送给Leader节点<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#写入请求发送给follower节点"><!---->写入请求发送给follower节点<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#服务器动态上下线监听案例"><!---->服务器动态上下线监听案例<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#服务端注册"><!---->服务端注册<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#客户端监听"><!---->客户端监听<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#实现过程"><!---->实现过程<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#原生zookeeper实现分布式锁"><!---->原生Zookeeper实现分布式锁<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#curator-框架实现分布式锁"><!---->Curator 框架实现分布式锁<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#原生的-java-api-开发存在的问题"><!---->原生的 Java API 开发存在的问题<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#curator-示例"><!---->Curator 示例<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#选举机制-1"><!---->选举机制<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#生产集群安装多少-zk-合适"><!---->生产集群安装多少 zk 合适？<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/Java/Zookeeper.html#zookeeper-是如何保证数据一致性的"><!---->Zookeeper 是如何保证数据一致性的？<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/Java/Nginx.html"><!---->Nginx<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/Java/RabbitMQ.html"><!---->RabbitMQ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/Java/RocketMQ.html"><!---->RocketMQ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/Java/ActiveMQ.html"><!---->ActiveMQ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/Java/Elasticsearch.html"><!---->Elasticsearch<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Spring Cloud</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Specified</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Tools</span><span class="vp-arrow end"></span></button><!----></section></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">DevOps</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">BigData</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">Python</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">MachineLearning</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">GIS</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">Web</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">Go</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">C/C++</span><span class="vp-arrow end"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->Zookeeper</h1><div class="page-info"><span class="page-author-info" aria-label="Author🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">MineTing</span></span><span property="author" content="MineTing"></span></span><!----><span class="page-date-info" aria-label="Writing Date📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-03-16T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="Reading Time⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>About 24 min</span><meta property="timeRequired" content="PT24M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">On This Page<!----></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#简介">简介</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#zookeeper-工作机制">Zookeeper 工作机制</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#zookeeper-特点">Zookeeper 特点</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#数据结构">数据结构</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#应用场景">应用场景</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#统一命名服务">统一命名服务</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#统一配置管理">统一配置管理</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#统一集群管理">统一集群管理</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#服务器动态上下线">服务器动态上下线</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#软负载均衡">软负载均衡</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#安装说明">安装说明</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#配置参数解读">配置参数解读</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#集群安装">集群安装</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#选举机制">选举机制</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#第一次启动">第一次启动</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#非第一次启动">非第一次启动</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#客户端命令行操作">客户端命令行操作</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#基本语法">基本语法</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#znode-节点数据信息">znode 节点数据信息</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#节点类型-持久-短暂-有序号-无序号">节点类型（持久/短暂/有序号/无序号）</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#监听器原理">监听器原理</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#节点删除与查看">节点删除与查看</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#客户端-api-操作">客户端 API 操作</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#创建工程">创建工程</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#创建-zookeeper-客户端">创建 ZooKeeper 客户端</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#创建节点">创建节点</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#监听子节点变化">监听子节点变化</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#判断节点是否存在">判断节点是否存在</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#客户端向服务端写数据流程">客户端向服务端写数据流程</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#写入请求直接发送给leader节点">写入请求直接发送给Leader节点</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#写入请求发送给follower节点">写入请求发送给follower节点</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#服务器动态上下线监听案例">服务器动态上下线监听案例</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#服务端注册">服务端注册</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#客户端监听">客户端监听</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#实现过程">实现过程</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#原生zookeeper实现分布式锁">原生Zookeeper实现分布式锁</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#curator-框架实现分布式锁">Curator 框架实现分布式锁</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#原生的-java-api-开发存在的问题">原生的 Java API 开发存在的问题</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#curator-示例">Curator 示例</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#选举机制-1">选举机制</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#生产集群安装多少-zk-合适">生产集群安装多少 zk 合适？</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#zookeeper-是如何保证数据一致性的">Zookeeper 是如何保证数据一致性的？</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><div align="center"><!----></div><h1 id="zookeeper-概述" tabindex="-1"><a class="header-anchor" href="#zookeeper-概述" aria-hidden="true">#</a> Zookeeper 概述</h1><h2 id="简介" tabindex="-1"><a class="header-anchor" href="#简介" aria-hidden="true">#</a> 简介</h2><p>Zookeeper 是一个开源的分布式的，为分布式框架提供协调服务的 Apache 项目。</p><p>官网：<a href="https://zookeeper.apache.org/" target="_blank" rel="noopener noreferrer">https://zookeeper.apache.org/<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h2 id="zookeeper-工作机制" tabindex="-1"><a class="header-anchor" href="#zookeeper-工作机制" aria-hidden="true">#</a> Zookeeper 工作机制</h2><p>​ 是一个基于观察者模式设计的分布式服务管理框架，它负责存储和管理大家都关心的数据，然后接受观察者的注册，一旦这些数据的状态发生变化，Zookeeper 就将负责通知已经在 Zookeeper 上注册的那些观察者做出相应的反应。</p><p>Zookeeper = 文件系统 + 通知机制</p><h2 id="zookeeper-特点" tabindex="-1"><a class="header-anchor" href="#zookeeper-特点" aria-hidden="true">#</a> Zookeeper 特点</h2><figure><img src="/assets/image-20220927215643357-5e9213fe.png" alt="image-20220927215643357" tabindex="0" loading="lazy"><figcaption>image-20220927215643357</figcaption></figure><ol><li>Zookeeper：一个领导者（Leader），多个跟随者（Follower）组成的集群。</li><li>集群中只要有半数以上节点存活，Zookeeper 集群就能正常服务。所以 Zookeeper 适合安装奇数台服务器。</li><li>全局数据一致：每个 Server 保存一份相同的数据副本，Client无论连接到哪个 Server，数据都是一致的。</li><li>更新请求顺序执行，来自同一个 Client 的更新请求按其发送顺序依次执行。</li><li>数据更新原子性，一次数据更新要么成功，要么失败。</li><li>实时性，在一定时间范围内，Client 能读到最新数据。</li></ol><h2 id="数据结构" tabindex="-1"><a class="header-anchor" href="#数据结构" aria-hidden="true">#</a> 数据结构</h2><p>​ ZooKeeper 数据模型的结构与 Unix 文件系统很类似，整体上可以看作是一棵树，每个 节点称做一个 ZNode。每一个 ZNode 默认能够存储 1MB 的数据，每个 ZNode 都可以通过其路径唯一标识。</p><figure><img src="/assets/image-20220927173947210-d9006d78.png" alt="image-20220927173947210" tabindex="0" loading="lazy"><figcaption>image-20220927173947210</figcaption></figure><h2 id="应用场景" tabindex="-1"><a class="header-anchor" href="#应用场景" aria-hidden="true">#</a> 应用场景</h2><p>提供的服务包括：统一命名服务、统一配置管理、统一集群管理、服务器节点动态上下线、软负载均衡等。</p><h3 id="统一命名服务" tabindex="-1"><a class="header-anchor" href="#统一命名服务" aria-hidden="true">#</a> 统一命名服务</h3><p>​ 在分布式环境下，经常需要对应用 / 服务进行统一命名，便于识别。</p><h3 id="统一配置管理" tabindex="-1"><a class="header-anchor" href="#统一配置管理" aria-hidden="true">#</a> 统一配置管理</h3><p>分布式环境中，一般要求一个集群中，所有节点的配置信息是一致的，比如 Kafka 集群，对配置文件修改后，希望能够快速同步到各个节点上。</p><p>Zookeeper 可实现该功能，可以将配置信息写入 Zookeeper 的一个 Znode，各个客户端服务器监听这个 Znode，一 旦Znode中的数据被修改，ZooKeeper将通知各个客户端服务器。</p><figure><img src="/assets/image-20220927175059036-d5f2248c.png" alt="image-20220927175059036" tabindex="0" loading="lazy"><figcaption>image-20220927175059036</figcaption></figure><h3 id="统一集群管理" tabindex="-1"><a class="header-anchor" href="#统一集群管理" aria-hidden="true">#</a> 统一集群管理</h3><p>分布式环境中，实时掌握每个节点的状态是必要的，可根据节点实时状态做出一些调整。</p><p>ZooKeeper可以实现实时监控节点状态变化：</p><p>​ 1. 可将节点信息写入ZooKeeper上的一个ZNode</p><p>​ 2. 监听这个ZNode可获取它的实时状态变化</p><h3 id="服务器动态上下线" tabindex="-1"><a class="header-anchor" href="#服务器动态上下线" aria-hidden="true">#</a> 服务器动态上下线</h3><p>​ 客户端能实时洞察到服务 器上下线的变化</p><figure><img src="/assets/image-20220927175315238-e0e5f1e7.png" alt="image-20220927175315238" tabindex="0" loading="lazy"><figcaption>image-20220927175315238</figcaption></figure><h3 id="软负载均衡" tabindex="-1"><a class="header-anchor" href="#软负载均衡" aria-hidden="true">#</a> 软负载均衡</h3><p>在 Zookeeper 中记录每台服务器的访问数，让访问数最少的服务器去处理最新的客户端请求</p><h1 id="zookeeper-本地安装" tabindex="-1"><a class="header-anchor" href="#zookeeper-本地安装" aria-hidden="true">#</a> Zookeeper 本地安装</h1><h2 id="安装说明" tabindex="-1"><a class="header-anchor" href="#安装说明" aria-hidden="true">#</a> 安装说明</h2><p>地址：<a href="https://zookeeper.apache.org/releases.html" target="_blank" rel="noopener noreferrer">https://zookeeper.apache.org/releases.html<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>下载安装包：apache-zookeeper-3.5.7-bin.tar.gz</p><p>安装准备：安装 JDK，解压至 /opt/zookeeper/，重命名文件夹名称</p><p>配置 Java 环境变量：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># java</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span>/opt/java/jdk1.8.0_131
<span class="token builtin class-name">export</span> <span class="token assign-left variable">JRE_HOME</span><span class="token operator">=</span>/opt/java/jdk1.8.0_131/jre
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CLASSPATH</span><span class="token operator">=</span>.:%JAVA_HOME%/lib:%JAVA_HOME%/lib
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token variable">$JAVA_HOME</span>/bin:<span class="token environment constant">$PATH</span>

<span class="token comment"># zookeeper</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">ZOOKEEPER_HOME</span><span class="token operator">=</span>/opt/zookeeper/zookeeper-3.5.7
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token variable">$ZOOKEEPER_HOME</span>/bin:<span class="token environment constant">$PATH</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">source</span> /etc/profile
<span class="token comment"># 或者修改 ~/.bash_profile， source ~/.bash_profile</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>解压 Zookeeper：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@root zookeeper<span class="token punctuation">]</span><span class="token comment"># ll zookeeper-3.5.7/</span>
总用量 <span class="token number">32</span>
drwxr-xr-x. <span class="token number">2</span>  <span class="token number">502</span> games   <span class="token number">232</span> <span class="token number">2</span>月  <span class="token number">10</span> <span class="token number">2020</span> bin
drwxr-xr-x. <span class="token number">2</span>  <span class="token number">502</span> games    <span class="token number">77</span> <span class="token number">2</span>月   <span class="token number">7</span> <span class="token number">2020</span> conf
drwxr-xr-x. <span class="token number">5</span>  <span class="token number">502</span> games  <span class="token number">4096</span> <span class="token number">2</span>月  <span class="token number">10</span> <span class="token number">2020</span> docs
drwxr-xr-x. <span class="token number">2</span> root root   <span class="token number">4096</span> <span class="token number">9</span>月  <span class="token number">27</span> <span class="token number">18</span>:40 lib
-rw-r--r--. <span class="token number">1</span>  <span class="token number">502</span> games <span class="token number">11358</span> <span class="token number">9</span>月  <span class="token number">13</span> <span class="token number">2018</span> LICENSE.txt
-rw-r--r--. <span class="token number">1</span>  <span class="token number">502</span> games   <span class="token number">432</span> <span class="token number">2</span>月  <span class="token number">10</span> <span class="token number">2020</span> NOTICE.txt
-rw-r--r--. <span class="token number">1</span>  <span class="token number">502</span> games  <span class="token number">1560</span> <span class="token number">2</span>月   <span class="token number">7</span> <span class="token number">2020</span> README.md
-rw-r--r--. <span class="token number">1</span>  <span class="token number">502</span> games  <span class="token number">1347</span> <span class="token number">2</span>月   <span class="token number">7</span> <span class="token number">2020</span> README_packaging.txt
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改配置：将 conf 路径下 zoo_sample.cfg 修改为 zoo.cfg，并修改文件中 dataDir 的路径，一般设置为安装目录下的 zkData（mkdir zkData）</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@root conf<span class="token punctuation">]</span><span class="token comment"># mv zoo_sample.cfg zoo.cfg</span>
<span class="token punctuation">[</span>root@root conf<span class="token punctuation">]</span><span class="token comment"># vim zoo.cfg</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># The number of milliseconds of each tick</span>
<span class="token assign-left variable">tickTime</span><span class="token operator">=</span><span class="token number">2000</span>
<span class="token comment"># The number of ticks that the initial</span>
<span class="token comment"># synchronization phase can take</span>
<span class="token assign-left variable">initLimit</span><span class="token operator">=</span><span class="token number">10</span>
<span class="token comment"># The number of ticks that can pass between</span>
<span class="token comment"># sending a request and getting an acknowledgement</span>
<span class="token assign-left variable">syncLimit</span><span class="token operator">=</span><span class="token number">5</span>
<span class="token comment"># the directory where the snapshot is stored.</span>
<span class="token comment"># do not use /tmp for storage, /tmp here is just</span>
<span class="token comment"># example sakes.</span>
<span class="token comment"># dataDir=/tmp/zookeeper</span>
<span class="token assign-left variable">dataDir</span><span class="token operator">=</span>/opt/zookeeper/zookeeper-3.5.7/zkData
<span class="token comment"># the port at which the clients will connect</span>
<span class="token assign-left variable">clientPort</span><span class="token operator">=</span><span class="token number">2181</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>操作 Zookeeper：</p><p>​ 启动 Zookeeper：<a href="http://zkServer.sh" target="_blank" rel="noopener noreferrer">zkServer.sh<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> start</p><p>​ 查看进程是否启动：jps</p><p>​ 查看状态：<a href="http://zkServer.sh" target="_blank" rel="noopener noreferrer">zkServer.sh<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> status</p><p>​ 启动客户端：<a href="http://zkCli.sh" target="_blank" rel="noopener noreferrer">zkCli.sh<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>​ 退出客户端：quit</p><p>​ 停止 Zookeeper：<a href="http://zkServer.sh" target="_blank" rel="noopener noreferrer">zkServer.sh<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> stop</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@root zookeeper-3.5.7<span class="token punctuation">]</span><span class="token comment"># cd bin</span>
<span class="token punctuation">[</span>root@root bin<span class="token punctuation">]</span><span class="token comment"># zkServer.sh start</span>
ZooKeeper JMX enabled by default
Using config: /opt/zookeeper/zookeeper-3.5.7/bin/<span class="token punctuation">..</span>/conf/zoo.cfg
Starting zookeeper <span class="token punctuation">..</span>. STARTED
<span class="token punctuation">[</span>root@root bin<span class="token punctuation">]</span><span class="token comment"># jps</span>
<span class="token number">5191</span> Jps
<span class="token number">5160</span> QuorumPeerMain
<span class="token punctuation">[</span>root@root bin<span class="token punctuation">]</span><span class="token comment"># zkServer.sh status</span>
ZooKeeper JMX enabled by default
Using config: /opt/zookeeper/zookeeper-3.5.7/bin/<span class="token punctuation">..</span>/conf/zoo.cfg
Client port found: <span class="token number">2181</span>. Client address: localhost.
Mode: standalone
<span class="token comment"># 退出</span>
<span class="token punctuation">[</span>root@root bin<span class="token punctuation">]</span><span class="token comment"># zkServer.sh stop</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@root bin<span class="token punctuation">]</span><span class="token comment"># zkCli.sh</span>
<span class="token comment">#.....</span>
<span class="token number">2022</span>-09-27 <span class="token number">19</span>:09:18,427 <span class="token punctuation">[</span>myid:localhost:2181<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main-SendThread<span class="token punctuation">(</span>localhost:2181<span class="token punctuation">)</span>:ClientCnxn<span class="token variable">$SendThread</span>@1394<span class="token punctuation">]</span> - Session establishment complete on server localhost/127.0.0.1:2181, sessionid <span class="token operator">=</span> 0x10000be49f20002, negotiated <span class="token function">timeout</span> <span class="token operator">=</span> <span class="token number">30000</span>

WATCHER::

WatchedEvent state:SyncConnected type:None path:null
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token function">ls</span> /
<span class="token punctuation">[</span>zookeeper<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="配置参数解读" tabindex="-1"><a class="header-anchor" href="#配置参数解读" aria-hidden="true">#</a> 配置参数解读</h2><p>配置文件 zoo.cfg 中参数含义：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># The number of milliseconds of each tick</span>
<span class="token assign-left variable">tickTime</span><span class="token operator">=</span><span class="token number">2000</span>
<span class="token comment"># The number of ticks that the initial</span>
<span class="token comment"># synchronization phase can take</span>
<span class="token assign-left variable">initLimit</span><span class="token operator">=</span><span class="token number">10</span>
<span class="token comment"># The number of ticks that can pass between</span>
<span class="token comment"># sending a request and getting an acknowledgement</span>
<span class="token assign-left variable">syncLimit</span><span class="token operator">=</span><span class="token number">5</span>
<span class="token comment"># the directory where the snapshot is stored.</span>
<span class="token comment"># do not use /tmp for storage, /tmp here is just</span>
<span class="token comment"># example sakes.</span>
<span class="token comment"># dataDir=/tmp/zookeeper</span>
<span class="token assign-left variable">dataDir</span><span class="token operator">=</span>/opt/zookeeper/zookeeper-3.5.7/zkData
<span class="token comment"># the port at which the clients will connect</span>
<span class="token assign-left variable">clientPort</span><span class="token operator">=</span><span class="token number">2181</span>
<span class="token comment"># the maximum number of client connections.</span>
<span class="token comment"># increase this if you need to handle more clients</span>
<span class="token comment">#maxClientCnxns=60</span>
<span class="token comment">#</span>
<span class="token comment"># Be sure to read the maintenance section of the</span>
<span class="token comment"># administrator guide before turning on autopurge.</span>
<span class="token comment">#</span>
<span class="token comment"># http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance</span>
<span class="token comment">#</span>
<span class="token comment"># The number of snapshots to retain in dataDir</span>
<span class="token comment">#autopurge.snapRetainCount=3</span>
<span class="token comment"># Purge task interval in hours</span>
<span class="token comment"># Set to &quot;0&quot; to disable auto purge feature</span>
<span class="token comment">#autopurge.purgeInterval=1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>tickTime = 2000：通信心跳时间，Zookeeper服务器与客户端心跳时间，单位毫秒</p><p>initLimit = 10：LF 初始通信时限，Leader和Follower初始连接时能容忍的最多心跳数**（tickTime的数量）**</p><p>syncLimit = 5：LF 同步通信时限，Leader和Follower之间通信时间如果超过syncLimit * tickTime，Leader认为Follwer死 掉，从服务器列表中删除Follwer。</p><p>dataDir：保存Zookeeper中的数据，默认的tmp目录，容易被Linux系统定期删除，所以一般不用默认的tmp目录。</p><p>clientPort = 2181：客户端连接端口，通常不做修改。</p><p>maxClientCnxns=60：客户端最大连接数量</p><p>参数说明：<a href="https://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance" target="_blank" rel="noopener noreferrer">https://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h1 id="zookeeper-集群操作" tabindex="-1"><a class="header-anchor" href="#zookeeper-集群操作" aria-hidden="true">#</a> Zookeeper 集群操作</h1><h2 id="集群安装" tabindex="-1"><a class="header-anchor" href="#集群安装" aria-hidden="true">#</a> 集群安装</h2><ol><li><p>在三台机器上安装 Zookeeper</p></li><li><p>配置服务器编号：<strong>在安装目录配置 zkData，在 zkData 下创建 myid 文件，在文件中添加与 server 对应的编号</strong></p></li><li><p>分发 zookeeper 至其他机器</p></li><li><p>配置 zoo.cfg文件，增加如下配置：</p><p>server.1=192.168.100.100:2888:3888</p><p>server.2=192.168.100.110:2888:3888</p><p>server.3=192.168.100.120:2888:3888</p><p>配置参数说明：</p><p>server.A=B:C:D</p><p>A 表示集群模式下，配置一个文件 myid 中的机器编号，Zookeeper 启动时读取此文件，拿到里面的数据与 zoo.cfg 里 面的配置信息比较从而判断到底是哪个 server。</p><p>B 是服务器的地址</p><p>C 是这个服务器 Follower 与集群中的 Leader 服务器交换信息的端口</p><p>D 是用来执行选举时服务器相互通信的端口。</p></li><li><p>同步配置文件</p><blockquote><p>批量进行跨机器间的文件（含文件夹）传输</p><ul><li>创建脚本 <a href="http://xsync.sh" target="_blank" rel="noopener noreferrer">xsync.sh<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>，传入要传输的目录名</li><li>shell 脚本要求具有执行权限：chmod +x <a href="http://xsync.sh" target="_blank" rel="noopener noreferrer">xsync.sh<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li>shell 脚本保存在 /usr/bin 这样的目录下，以使命令全局有效</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token comment"># 判断参数个数</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$#</span> <span class="token parameter variable">-lt</span> <span class="token number">1</span> <span class="token punctuation">]</span>
<span class="token keyword">then</span>
	<span class="token builtin class-name">echo</span> <span class="token string">&quot;Not  Enough Arguments&quot;</span>
	<span class="token builtin class-name">exit</span>
<span class="token keyword">fi</span>
<span class="token comment"># 遍历所有主机</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token number">192.168</span>.100.100 <span class="token number">192.168</span>.100.110 <span class="token number">192.168</span>.100.120
<span class="token keyword">do</span>
	<span class="token builtin class-name">echo</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token variable">$host</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
	<span class="token comment"># 遍历所有目录</span>
	<span class="token keyword">for</span> <span class="token for-or-select variable">file</span> <span class="token keyword">in</span> <span class="token variable">$@</span>
	<span class="token keyword">do</span>
		<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-e</span> <span class="token variable">$file</span> <span class="token punctuation">]</span>
		<span class="token keyword">then</span>
			<span class="token comment"># 如果文件存在，获取父目录，</span>
			<span class="token comment"># pwd -P：如果目录是链接时，显示出实际路径，而非使用连接（link）路径。pwd防止传入相对路径</span>
			<span class="token comment"># cd -P:如果目录是链接时，切换到实际路径的目录。</span>
			<span class="token assign-left variable">pdir</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">cd</span> <span class="token parameter variable">-P</span> <span class="token punctuation">$(</span>dirname $file<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>
			<span class="token comment"># 获取文件名称</span>
			<span class="token assign-left variable">filename</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">basename</span> $file<span class="token variable">)</span></span>
			<span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">&quot;mkdir -p <span class="token variable">$pdir</span>&quot;</span>
			<span class="token function">rsync</span> <span class="token parameter variable">-av</span> <span class="token variable">$pdir</span>/<span class="token variable">$filename</span> <span class="token variable">$host</span><span class="token builtin class-name">:</span><span class="token variable">$pdir</span>
		<span class="token keyword">else</span>
			<span class="token builtin class-name">echo</span> <span class="token variable">$file</span> not exist<span class="token operator">!</span>
		<span class="token keyword">fi</span>
	<span class="token keyword">done</span>
<span class="token keyword">done</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><p><strong>同步完成后，修改配置文件内容。</strong></p></li><li><p>启动 Zookeeper 并查看状态</p><blockquote><p>启动 Zookeeper 集群，脚本位置：/home/xxxx/bin</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token keyword">case</span> <span class="token variable">$1</span> <span class="token keyword">in</span>
<span class="token string">&quot;start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token number">192.168</span>.100.100 <span class="token number">192.168</span>.100.110 <span class="token number">192.168</span>.100.120
	<span class="token keyword">do</span>
		<span class="token builtin class-name">echo</span> <span class="token string">&quot;========zookeeper <span class="token variable">$host</span> start========&quot;</span>
		<span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">&quot;/opt/zookeeper/zookeeper-3.5.7/bin/zkServer.sh start&quot;</span>
	<span class="token keyword">done</span>
<span class="token punctuation">}</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token string">&quot;status&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token number">192.168</span>.100.100 <span class="token number">192.168</span>.100.110 <span class="token number">192.168</span>.100.120
	<span class="token keyword">do</span>
		<span class="token builtin class-name">echo</span> <span class="token string">&quot;========zookeeper <span class="token variable">$host</span> status========&quot;</span>
		<span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">&quot;/opt/zookeeper/zookeeper-3.5.7/bin/zkServer.sh status&quot;</span>
	<span class="token keyword">done</span>
<span class="token punctuation">}</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token string">&quot;stop&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token number">192.168</span>.100.100 <span class="token number">192.168</span>.100.110 <span class="token number">192.168</span>.100.120
	<span class="token keyword">do</span>
		<span class="token builtin class-name">echo</span> <span class="token string">&quot;========zookeeper <span class="token variable">$host</span> stop========&quot;</span>
		<span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">&quot;/opt/zookeeper/zookeeper-3.5.7/bin/zkServer.sh stop&quot;</span>
	<span class="token keyword">done</span>
<span class="token punctuation">}</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">esac</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>设置免密登陆：</p></blockquote></li></ol><blockquote><p>安装 sshpass 工具： yum -y install sshpass</p><p>修改：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token keyword">case</span> <span class="token variable">$1</span> <span class="token keyword">in</span>
<span class="token string">&quot;start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token number">192.168</span>.100.100 <span class="token number">192.168</span>.100.110 <span class="token number">192.168</span>.100.120
	<span class="token keyword">do</span>
		<span class="token builtin class-name">echo</span> <span class="token string">&quot;========zookeeper <span class="token variable">$host</span> start========&quot;</span>
		sshpass <span class="token parameter variable">-p</span> root <span class="token function">ssh</span> <span class="token parameter variable">-o</span> <span class="token assign-left variable">StrictHostKeyChecking</span><span class="token operator">=</span>no <span class="token variable">$host</span> <span class="token string">&quot;/opt/zookeeper/zookeeper-3.5.7/bin/zkServer.sh start&quot;</span>
	<span class="token keyword">done</span>
<span class="token punctuation">}</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token string">&quot;status&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token number">192.168</span>.100.100 <span class="token number">192.168</span>.100.110 <span class="token number">192.168</span>.100.120
	<span class="token keyword">do</span>
		<span class="token builtin class-name">echo</span> <span class="token string">&quot;========zookeeper <span class="token variable">$host</span> status========&quot;</span>
		sshpass <span class="token parameter variable">-p</span> root <span class="token function">ssh</span> <span class="token parameter variable">-o</span> <span class="token assign-left variable">StrictHostKeyChecking</span><span class="token operator">=</span>no <span class="token variable">$host</span> <span class="token string">&quot;/opt/zookeeper/zookeeper-3.5.7/bin/zkServer.sh status&quot;</span>
	<span class="token keyword">done</span>
<span class="token punctuation">}</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token string">&quot;stop&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token number">192.168</span>.100.100 <span class="token number">192.168</span>.100.110 <span class="token number">192.168</span>.100.120
	<span class="token keyword">do</span>
		<span class="token builtin class-name">echo</span> <span class="token string">&quot;========zookeeper <span class="token variable">$host</span> stop========&quot;</span>
		sshpass <span class="token parameter variable">-p</span> root <span class="token function">ssh</span> <span class="token parameter variable">-o</span> <span class="token assign-left variable">StrictHostKeyChecking</span><span class="token operator">=</span>no <span class="token variable">$host</span> <span class="token string">&quot;/opt/zookeeper/zookeeper-3.5.7/bin/zkServer.sh stop&quot;</span>
	<span class="token keyword">done</span>
<span class="token punctuation">}</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">esac</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>linux 设置免密登陆：略</p></blockquote><pre><code>注意报错：

```shell
# 如果报错：Error: JAVA_HOME is not set and java could not be found in PATH.
# 单机启动没有问题，但集群启动报错
# 解决：在 zookeeper/bin/zkEnv.sh 头部手动添加 JAVA_HOME=/opt/java/jdk1.8.0_131
# 修改完成后，重新分发
```

```shell
[root@root zookeeper-3.5.7]# zkServer.sh status
ZooKeeper JMX enabled by default

```
</code></pre><p>Using config: /opt/zookeeper/zookeeper-3.5.7/bin/../conf/zoo.cfg<br> Client port found: 2181. Client address: localhost.<br> Error contacting service. It is probably not running.<br> ```</p><pre><code>原因：

  1. Leader 和 Follower 未选出，或无法连接

  2. 只启动不到一半数量的集群，或者防火墙未关闭

     防火墙：

     CentOS7：

     ```shell
     systemctl status firewalld.service
     systemctl stop firewalld.service	#关闭
     systemctl disabled firewalld.service	# 禁用
     ```

     CentOS6：

     ```shell
     service iptables status
     service iptables stop
     chkconfig iptables off
     ```

启动结果：
</code></pre><blockquote><p>查看 jps 进程，脚本 <a href="http://jpsall.sh" target="_blank" rel="noopener noreferrer">jpsall.sh<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> <span class="token number">192.168</span>.100.100 <span class="token number">192.168</span>.100.110 <span class="token number">192.168</span>.100.120
<span class="token keyword">do</span>
    <span class="token builtin class-name">echo</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token variable">$host</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
    <span class="token function">ssh</span> <span class="token variable">$host</span>  <span class="token string">&quot;source /etc/profile &amp;&amp; jps | grep -v jps &quot;</span>
<span class="token keyword">done</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><pre><code>查看状态：

```shell
[root@root zookeeper-3.5.7]# zk.sh status
========zookeeper 192.168.100.100 status========
Warning: Permanently added &#39;192.168.100.100&#39; (ECDSA) to the list of known hosts.
root@192.168.100.100&#39;s password:
/usr/bin/java
ZooKeeper JMX enabled by default
Using config: /opt/zookeeper/zookeeper-3.5.7/bin/../conf/zoo.cfg
Client port found: 2181. Client address: localhost.
Mode: follower
========zookeeper 192.168.100.110 status========
Warning: Permanently added &#39;192.168.100.110&#39; (ECDSA) to the list of known hosts.
root@192.168.100.110&#39;s password:
/usr/bin/java
ZooKeeper JMX enabled by default
Using config: /opt/zookeeper/zookeeper-3.5.7/bin/../conf/zoo.cfg
Client port found: 2181. Client address: localhost.
Mode: leader
========zookeeper 192.168.100.120 status========
Warning: Permanently added &#39;192.168.100.120&#39; (ECDSA) to the list of known hosts.
root@192.168.100.120&#39;s password:
/usr/bin/java
ZooKeeper JMX enabled by default
Using config: /opt/zookeeper/zookeeper-3.5.7/bin/../conf/zoo.cfg
Client port found: 2181. Client address: localhost.
Mode: follower
[root@root zookeeper-3.5.7]#
```

说明：此时已经选举出 leader 和 follower
</code></pre><h2 id="选举机制" tabindex="-1"><a class="header-anchor" href="#选举机制" aria-hidden="true">#</a> 选举机制</h2><h3 id="第一次启动" tabindex="-1"><a class="header-anchor" href="#第一次启动" aria-hidden="true">#</a> 第一次启动</h3><figure><img src="/assets/image-20220927215757995-7706c9e2.png" alt="image-20220927215757995" tabindex="0" loading="lazy"><figcaption>image-20220927215757995</figcaption></figure><ol><li><p>服务器1启 动，发起一次选举。服务器1投自己一票。此时服务器1票数一票，不够半数以上（3票），选举无法完成，服务器1状态保持为 LOOKING。</p></li><li><p>服务器2启动，再发起一次选举。服务器1和2分别投自己一票并交换选票信息：此时服务器 1 发现服务器 2 的myid 比自己目前投票推举的（服务器1） 大，更改选票为推举服务器2。此时服务器1票数0票，服务器2票数2票，没有半数以上结果，选举无法完成，服务器1，2状态保持LOOKING。</p></li><li><p>服务器3启动，发起一次选举。此时服务器1和2都会更改选票为服务器3。此次投票结果：服务器1为0票，服务器2为 0 票，服务器3为3票。此时服务器3的票数已经超过半数，服务器3当选Leader。服务器1，2 更改状态为FOLLOWING，服务器3更改状态为 LEADING</p></li><li><p>服务器4启动，发起一次选举。此时服务器1，2，3已经不是LOOKING状态，不会更改选票信息。交换选票信息结果：服务器3为3票，服务器4为 1票。此时服务器4服从多数，更改选票信息为服务器3，并更改状态为 FOLLOWING；</p></li><li><p>服务器5启动，同服务器4一样作为follwer。</p></li></ol><p><strong>注意：客户端的每次写操作都有 事务id（zxid）</strong></p><p>SID：服务器ID。用来唯一标识一台 ZooKeeper 集群中的机器，每台机器不能重复，和myid一致。</p><p>ZXID：事务ID。ZXID是一个事务ID，用来标识一次服务器状态的变更。在某一时刻， 集群中的每台机器的 ZXID 值不一 定完全一 致，这和 ZooKeeper 服务器对于客户端 &quot;更新请求&quot; 的处理逻辑有关。</p><p>Epoch：每个Leader任期的代号。没有 Leader时同一轮投票过程中的逻辑时钟值是相同的。每投完一次票这个数据就会 增加。</p><h3 id="非第一次启动" tabindex="-1"><a class="header-anchor" href="#非第一次启动" aria-hidden="true">#</a> 非第一次启动</h3><figure><img src="/assets/image-20220927220711206-b71cfd8d.png" alt="image-20220927220711206" tabindex="0" loading="lazy"><figcaption>image-20220927220711206</figcaption></figure><p>当 ZooKeeper 集群中的一台服务器出现以下两种情况之一时，就会开始进入 Leader 选举：</p><ul><li><p>服务器初始化启动</p></li><li><p>服务器运行期间无法和Leader保持连接，此时需要进行选举。</p></li></ul><p>而当一台机器进入Leader选举流程时，当前集群也可能会处于以下两种状态：</p><ol><li><p>集群中本来就已经存在一个Leader。 对于第一种已经存在Leader的情况，机器试图去选举Leader时，会被告知当前服务器的Leader信息，对于该机器来说，仅仅需要和Leader机器建立连 接，并进行状态同步即可。</p></li><li><p>集群中确实不存在Leader（宕机）。</p><p>假设ZooKeeper由5台服务器组成，SID分别为1、2、3、4、5，ZXID分别为8、8、8、7、7，并且此时SID为3的服务器是Leader。某一时刻， 3和5服务器出现故障，因此开始进行Leader选举。</p></li></ol><p>​ （EPOCH，ZXID，SID ） （EPOCH，ZXID，SID ） （EPOCH，ZXID，SID ）</p><p>SID为1、2、4的机器投票情况： (1, 8, 1) （1，8，2） （1，7，4）</p><p>选举Leader规则： ① EPOCH大的直接胜出 ② EPOCH相同，事务id大的胜出 ③ 事务id相同，服务器id大的胜出</p><h2 id="客户端命令行操作" tabindex="-1"><a class="header-anchor" href="#客户端命令行操作" aria-hidden="true">#</a> 客户端命令行操作</h2><h3 id="基本语法" tabindex="-1"><a class="header-anchor" href="#基本语法" aria-hidden="true">#</a> 基本语法</h3><table><thead><tr><th>命令</th><th>描述信息</th></tr></thead><tbody><tr><td>ls [-s] [-w] [-R] path</td><td>查看当前节点的 znode 节点，-w ：监听子节点变化，-s：附加层级信息</td></tr><tr><td>create [-s] [-e] [-c] [-t ttl] path [data] [acl]</td><td>创建节点，-s：含有序列，-e：临时节点（重启或超时消失）</td></tr><tr><td>get [-s] [-w] path</td><td>获得节点的值 [可监听] -w 监听节点内容变化 -s 附加次级信息</td></tr><tr><td>set [-s] [-v version] path data</td><td>设置节点的具体值</td></tr><tr><td>stat [-w] path</td><td>查看节点状态</td></tr><tr><td>delete [-v version] path</td><td>删除节点</td></tr><tr><td>deleteall path</td><td>递归删除节点</td></tr></tbody></table><h3 id="znode-节点数据信息" tabindex="-1"><a class="header-anchor" href="#znode-节点数据信息" aria-hidden="true">#</a> znode 节点数据信息</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">17</span><span class="token punctuation">]</span> <span class="token function">ls</span> /
<span class="token punctuation">[</span>zookeeper<span class="token punctuation">]</span>
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">18</span><span class="token punctuation">]</span> <span class="token function">ls</span> <span class="token parameter variable">-s</span> /
<span class="token punctuation">[</span>zookeeper<span class="token punctuation">]</span>cZxid <span class="token operator">=</span> 0x0
ctime <span class="token operator">=</span> Thu Jan 01 08:00:00 CST <span class="token number">1970</span>
mZxid <span class="token operator">=</span> 0x0
mtime <span class="token operator">=</span> Thu Jan 01 08:00:00 CST <span class="token number">1970</span>
pZxid <span class="token operator">=</span> 0x0
cversion <span class="token operator">=</span> <span class="token parameter variable">-1</span>
dataVersion <span class="token operator">=</span> <span class="token number">0</span>
aclVersion <span class="token operator">=</span> <span class="token number">0</span>
ephemeralOwner <span class="token operator">=</span> 0x0
dataLength <span class="token operator">=</span> <span class="token number">0</span>
numChildren <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">19</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>czxid：创建节点的事务 zxid</li></ul><p>​ 每次修改 ZooKeeper 状态都会产生一个 ZooKeeper 事务 ID。事务 ID 是 ZooKeeper 中所有修改总的次序。每次修 改都有唯一的 zxid，如果 zxid1 小于 zxid2，那么 zxid1 在 zxid2 之前发生。</p><ul><li><p>ctime：znode 被创建的毫秒数（从 1970 年开始）</p></li><li><p>mzxid：znode 最后更新的事务 zxid</p></li><li><p>mtime：znode 最后修改的毫秒数（从 1970 年开始）</p></li><li><p>pZxid：znode 最后更新的子节点 zxid</p></li><li><p>cversion：znode 子节点变化号，znode 子节点修改次数</p></li><li><p>dataversion：znode 数据变化号</p></li><li><p>aclVersion：znode 访问控制列表的变化号</p></li><li><p>ephemeralOwner：如果是临时节点，这个是 znode 拥有者的 session id。如果不是 临时节点则是 0。</p></li><li><p>dataLength：znode 的数据长度</p></li><li><p>numChildren：znode 子节点数量</p></li></ul><h3 id="节点类型-持久-短暂-有序号-无序号" tabindex="-1"><a class="header-anchor" href="#节点类型-持久-短暂-有序号-无序号" aria-hidden="true">#</a> 节点类型（持久/短暂/有序号/无序号）</h3><p>持久（Persistent）：客户端和服务器端断开连接后，创建的节点不删除</p><p>短暂（Ephemeral）：客户端和服务器端断开连接后，创建的节点自己删除</p><p>顺序：创建 znode 时设置顺序标识，znode 名称后会附加一个值，顺序号是一个单调递增的计数器，由父节点维护</p><p>​ 在分布式系统中，顺序号可以被用于为所有的事件进行全局排序，这样客户端可以通过顺序号推断事件的顺序</p><ol><li><p>分别创建2个普通节点（永久节点 + 不带序号）</p><blockquote><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">14</span><span class="token punctuation">]</span> create /node01 <span class="token string">&quot;server01&quot;</span>
Created /node01
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">15</span><span class="token punctuation">]</span> create /node02/node03 <span class="token string">&quot;server03&quot;</span>
Node does not exist: /node02/node03
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">16</span><span class="token punctuation">]</span> create /node02 <span class="token string">&quot;server02&quot;</span>
Created /node02
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">17</span><span class="token punctuation">]</span> create /node02/node03 <span class="token string">&quot;server03&quot;</span>
Created /node02/node03
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">18</span><span class="token punctuation">]</span> create /node04
Created /node04
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意：创建节点时要赋值（否则为null），<strong>且不能创建多级节点</strong></p></blockquote></li><li><p>获取节点的值</p><blockquote><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">19</span><span class="token punctuation">]</span> get <span class="token parameter variable">-s</span> /node01
server01
cZxid <span class="token operator">=</span> 0x200000016
ctime <span class="token operator">=</span> Tue Sep <span class="token number">27</span> <span class="token number">23</span>:18:29 CST <span class="token number">2022</span>
mZxid <span class="token operator">=</span> 0x200000016
mtime <span class="token operator">=</span> Tue Sep <span class="token number">27</span> <span class="token number">23</span>:18:29 CST <span class="token number">2022</span>
pZxid <span class="token operator">=</span> 0x200000016
cversion <span class="token operator">=</span> <span class="token number">0</span>
dataVersion <span class="token operator">=</span> <span class="token number">0</span>
aclVersion <span class="token operator">=</span> <span class="token number">0</span>
ephemeralOwner <span class="token operator">=</span> 0x0
dataLength <span class="token operator">=</span> <span class="token number">8</span>
numChildren <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">20</span><span class="token punctuation">]</span> get <span class="token parameter variable">-s</span> /node02
server02
cZxid <span class="token operator">=</span> 0x200000018
ctime <span class="token operator">=</span> Tue Sep <span class="token number">27</span> <span class="token number">23</span>:18:56 CST <span class="token number">2022</span>
mZxid <span class="token operator">=</span> 0x200000018
mtime <span class="token operator">=</span> Tue Sep <span class="token number">27</span> <span class="token number">23</span>:18:56 CST <span class="token number">2022</span>
pZxid <span class="token operator">=</span> 0x200000019
cversion <span class="token operator">=</span> <span class="token number">1</span>
dataVersion <span class="token operator">=</span> <span class="token number">0</span>
aclVersion <span class="token operator">=</span> <span class="token number">0</span>
ephemeralOwner <span class="token operator">=</span> 0x0
dataLength <span class="token operator">=</span> <span class="token number">8</span>
numChildren <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">21</span><span class="token punctuation">]</span> get <span class="token parameter variable">-s</span> /node04
null
cZxid <span class="token operator">=</span> 0x20000001a
ctime <span class="token operator">=</span> Tue Sep <span class="token number">27</span> <span class="token number">23</span>:19:23 CST <span class="token number">2022</span>
mZxid <span class="token operator">=</span> 0x20000001a
mtime <span class="token operator">=</span> Tue Sep <span class="token number">27</span> <span class="token number">23</span>:19:23 CST <span class="token number">2022</span>
pZxid <span class="token operator">=</span> 0x20000001a
cversion <span class="token operator">=</span> <span class="token number">0</span>
dataVersion <span class="token operator">=</span> <span class="token number">0</span>
aclVersion <span class="token operator">=</span> <span class="token number">0</span>
ephemeralOwner <span class="token operator">=</span> 0x0
dataLength <span class="token operator">=</span> <span class="token number">0</span>
numChildren <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">22</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote></li><li><p>创建带序号的节点（永久节点 + 带序号）</p><p>​ <strong>如果原来没有节点，序号从 0 开始依次递增。如果原节点下已有 2 个节点，则再排序时从 2 开始，以此类推。</strong></p><blockquote><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">10</span><span class="token punctuation">]</span> create /nodeA <span class="token string">&quot;serverA&quot;</span>
Created /nodeA
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">11</span><span class="token punctuation">]</span> create /nodeA/nodeB <span class="token string">&quot;serverB&quot;</span>
Created /nodeA/nodeB
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">12</span><span class="token punctuation">]</span> create <span class="token parameter variable">-s</span> /nodeA/nodeC <span class="token string">&quot;serverC&quot;</span>
Created /nodeA/nodeC0000000001
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">13</span><span class="token punctuation">]</span> create <span class="token parameter variable">-s</span> /nodeA/nodeD <span class="token string">&quot;serverD&quot;</span>
Created /nodeA/nodeD0000000002
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">14</span><span class="token punctuation">]</span> create <span class="token parameter variable">-s</span> /nodeA/nodeC <span class="token string">&quot;serverCC&quot;</span>
Created /nodeA/nodeC0000000003
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">15</span><span class="token punctuation">]</span> get <span class="token parameter variable">-s</span> /nodeA/nodeC
org.apache.zookeeper.KeeperException<span class="token variable">$NoNodeException</span><span class="token builtin class-name">:</span> KeeperErrorCode <span class="token operator">=</span> NoNode <span class="token keyword">for</span> /nodeA/nodeC
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">19</span><span class="token punctuation">]</span> <span class="token function">ls</span> /nodeA
<span class="token punctuation">[</span>nodeB, nodeC0000000001, nodeC0000000003, nodeD0000000002<span class="token punctuation">]</span>
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">21</span><span class="token punctuation">]</span> create <span class="token parameter variable">-s</span> /nodeA/nodeB/nodeE <span class="token string">&quot;serverE&quot;</span>
Created /nodeA/nodeB/nodeE0000000000
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">20</span><span class="token punctuation">]</span> create <span class="token parameter variable">-s</span> /nodeE <span class="token string">&quot;serverE&quot;</span>
Created /nodeE0000000010
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote></li><li><p>创建短暂节点（短暂节点 + 不带序号 / 带序号）</p><blockquote><p>退出当前客户端然后再重启客户端，短暂节点已经删除</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">6</span><span class="token punctuation">]</span> create <span class="token parameter variable">-s</span> /tempNode <span class="token string">&quot;tempServer&quot;</span>
Created /tempNode0000000012
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">7</span><span class="token punctuation">]</span> create <span class="token parameter variable">-s</span> <span class="token parameter variable">-e</span> /tempNode <span class="token string">&quot;tempServer&quot;</span>
Created /tempNode0000000013
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">]</span> quit

WATCHER::

WatchedEvent state:Closed type:None path:null
<span class="token number">2022</span>-09-27 <span class="token number">23</span>:45:59,221 <span class="token punctuation">[</span>myid:<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main:ZooKeeper@1422<span class="token punctuation">]</span> - Session: 0x1000132016c0008 closed
<span class="token number">2022</span>-09-27 <span class="token number">23</span>:45:59,228 <span class="token punctuation">[</span>myid:<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main-EventThread:ClientCnxn<span class="token variable">$EventThread</span>@524<span class="token punctuation">]</span> - EventThread shut down <span class="token keyword">for</span> session: 0x1000132016c0008
<span class="token punctuation">[</span>root@root ~<span class="token punctuation">]</span><span class="token comment"># zkCli.sh</span>
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">]</span> get <span class="token parameter variable">-s</span> /tempNode0000000013
org.apache.zookeeper.KeeperException<span class="token variable">$NoNodeException</span><span class="token builtin class-name">:</span> KeeperErrorCode <span class="token operator">=</span> NoNode <span class="token keyword">for</span> /tempNode0000000013
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote></li><li><p>修改节点数据值</p><blockquote><p>dataVersion 会改变</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">]</span> get <span class="token parameter variable">-s</span> /nodeA
serverA
cZxid <span class="token operator">=</span> 0x200000025
ctime <span class="token operator">=</span> Tue Sep <span class="token number">27</span> <span class="token number">23</span>:27:02 CST <span class="token number">2022</span>
mZxid <span class="token operator">=</span> 0x200000025
mtime <span class="token operator">=</span> Tue Sep <span class="token number">27</span> <span class="token number">23</span>:27:02 CST <span class="token number">2022</span>
pZxid <span class="token operator">=</span> 0x200000029
cversion <span class="token operator">=</span> <span class="token number">4</span>
dataVersion <span class="token operator">=</span> <span class="token number">0</span>
aclVersion <span class="token operator">=</span> <span class="token number">0</span>
ephemeralOwner <span class="token operator">=</span> 0x0
dataLength <span class="token operator">=</span> <span class="token number">7</span>
numChildren <span class="token operator">=</span> <span class="token number">4</span>
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token builtin class-name">set</span> /nodeA <span class="token string">&quot;mserverA&quot;</span>
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">3</span><span class="token punctuation">]</span> get <span class="token parameter variable">-s</span> /nodeA
mserverA
cZxid <span class="token operator">=</span> 0x200000025
ctime <span class="token operator">=</span> Tue Sep <span class="token number">27</span> <span class="token number">23</span>:27:02 CST <span class="token number">2022</span>
mZxid <span class="token operator">=</span> 0x200000035
mtime <span class="token operator">=</span> Tue Sep <span class="token number">27</span> <span class="token number">23</span>:44:19 CST <span class="token number">2022</span>
pZxid <span class="token operator">=</span> 0x200000029
cversion <span class="token operator">=</span> <span class="token number">4</span>
dataVersion <span class="token operator">=</span> <span class="token number">1</span>
aclVersion <span class="token operator">=</span> <span class="token number">0</span>
ephemeralOwner <span class="token operator">=</span> 0x0
dataLength <span class="token operator">=</span> <span class="token number">8</span>
numChildren <span class="token operator">=</span> <span class="token number">4</span>
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">4</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote></li></ol><h3 id="监听器原理" tabindex="-1"><a class="header-anchor" href="#监听器原理" aria-hidden="true">#</a> 监听器原理</h3><p>​ 客户端注册监听它关心的目录节点，当目录节点发生变化（数据改变、节点删除、子目 录节点增加删除）时，ZooKeeper 会通知客户端。监听机制保证 ZooKeeper 保存的任何的数 据的任何改变都能快速的响应到监听了该节点的应用程序。</p><p>原理详解：</p><ol><li><p>在main线程中创建Zookeeper客户端，这时就会创建两个线程，一个负责网络连接通信（connet），一个负责监听（listener）。</p></li><li><p>通过 connect 线程将注册的监听事件发送给 Zookeeper。</p></li><li><p>在 Zookeeper 的注册监听器列表中将注册的监听事件添加到列表中。</p></li><li><p>Zookeeper 监听到有数据或路径变化，就会将这个消息发送给 listener 线程。</p></li><li><p>listener 线程内部调用了 process() 方法。</p><blockquote><figure><img src="/assets/image-20220927234552567-7420adc0.png" alt="image-20220927234552567" tabindex="0" loading="lazy"><figcaption>image-20220927234552567</figcaption></figure></blockquote></li></ol><p>常见的监听：</p><p>监听节点数据的变化：get path [watch]</p><p>监听子节点增减的变化：ls path [watch]</p><p>（1）节点的值变化监听：</p><blockquote><p>在 192.168.100.100 上监听节点的值，在192.168.100.110 上修改节点的值</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">10</span><span class="token punctuation">]</span> create /node01 <span class="token string">&quot;server01&quot;</span>
Created /node01
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">11</span><span class="token punctuation">]</span> get <span class="token parameter variable">-w</span> /node01
server01
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">12</span><span class="token punctuation">]</span>
WATCHER::

WatchedEvent state:SyncConnected type:NodeDataChanged path:/node01

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token function">ls</span> /
<span class="token punctuation">[</span>node01, zookeeper<span class="token punctuation">]</span>
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token builtin class-name">set</span> /node01 <span class="token string">&quot;node02&quot;</span>
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token builtin class-name">set</span> /node01 <span class="token string">&quot;node03&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意：注册一次，只能监听一次。</p></blockquote><p>（2）节点的子节点变化监听（路径变化）</p><blockquote><p>在 192.168.100.100 上监听节点的值，在192.168.100.110 上修改节点的值</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token function">ls</span> /
<span class="token punctuation">[</span>node01, zookeeper<span class="token punctuation">]</span>
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token function">ls</span> <span class="token parameter variable">-w</span> /node01
<span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">]</span>
WATCHER::

WatchedEvent state:SyncConnected type:NodeChildrenChanged path:/node01

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">]</span> create /node01/node02
Created /node01/node02
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">]</span> create /node01/node03
Created /node01/node03

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h3 id="节点删除与查看" tabindex="-1"><a class="header-anchor" href="#节点删除与查看" aria-hidden="true">#</a> 节点删除与查看</h3><blockquote><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token function">ls</span> /node01
<span class="token punctuation">[</span>node02, node03<span class="token punctuation">]</span>
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">]</span> deleteall /node01
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token function">ls</span> /
<span class="token punctuation">[</span>zookeeper<span class="token punctuation">]</span>
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token function">stat</span> /zookeeper
cZxid <span class="token operator">=</span> 0x0
ctime <span class="token operator">=</span> Thu Jan 01 08:00:00 CST <span class="token number">1970</span>
mZxid <span class="token operator">=</span> 0x0
mtime <span class="token operator">=</span> Thu Jan 01 08:00:00 CST <span class="token number">1970</span>
pZxid <span class="token operator">=</span> 0x0
cversion <span class="token operator">=</span> <span class="token parameter variable">-2</span>
dataVersion <span class="token operator">=</span> <span class="token number">0</span>
aclVersion <span class="token operator">=</span> <span class="token number">0</span>
ephemeralOwner <span class="token operator">=</span> 0x0
dataLength <span class="token operator">=</span> <span class="token number">0</span>
numChildren <span class="token operator">=</span> <span class="token number">2</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h2 id="客户端-api-操作" tabindex="-1"><a class="header-anchor" href="#客户端-api-操作" aria-hidden="true">#</a> 客户端 API 操作</h2><h3 id="创建工程" tabindex="-1"><a class="header-anchor" href="#创建工程" aria-hidden="true">#</a> 创建工程</h3><blockquote><p>pom.xml</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>    <span class="token operator">&lt;</span>dependencies<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>junit<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>junit<span class="token operator">&lt;</span>/artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span>RELEASE<span class="token operator">&lt;</span>/version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org.apache.logging.log4j<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>log4j-core<span class="token operator">&lt;</span>/artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">2.8</span>.<span class="token operator"><span class="token file-descriptor important">2</span>&lt;</span>/version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org.apache.zookeeper<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>zookeeper<span class="token operator">&lt;</span>/artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">3.5</span>.<span class="token operator"><span class="token file-descriptor important">7</span>&lt;</span>/version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>/dependencies<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>log4j.properties</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>log4j.rootLogger=INFO, stdout
log4j.appender.stdout=org.apache.log4j.ConsoleAppender
log4j.appender.stdout.layout=org.apache.log4j.PatternLayout
log4j.appender.stdout.layout.ConversionPattern=%d %p [%c] - %m%n
log4j.appender.logfile=org.apache.log4j.FileAppender
log4j.appender.logfile.File=target/spring.log
log4j.appender.logfile.layout=org.apache.log4j.PatternLayout
log4j.appender.logfile.layout.ConversionPattern=%d %p [%c] - %m%n
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h3 id="创建-zookeeper-客户端" tabindex="-1"><a class="header-anchor" href="#创建-zookeeper-客户端" aria-hidden="true">#</a> 创建 ZooKeeper 客户端</h3><p><strong>使用客户端 API 连接时，sessionTimeout 应该设置大些，否则报错：</strong></p><p>org.apache.zookeeper.KeeperException$ConnectionLossException: KeeperErrorCode = ConnectionLoss for /node01</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZkClient</span> <span class="token punctuation">{</span>
	<span class="token keyword">private</span> <span class="token class-name">ZooKeeper</span> zooKeeper <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> connectString <span class="token operator">=</span> <span class="token string">&quot;192.168.100.100:2181,192.168.100.110:2181,192.168.100.120:2181&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// 注意，该值在确保网络，防火墙关闭的情况下，值应该设置大一点</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> sessionTimeout <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 创建 ZooKeeper 客户端
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span>
     */</span>
    <span class="token annotation punctuation">@Before</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            zooKeeper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span>connectString<span class="token punctuation">,</span> sessionTimeout<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 监听节点变化（值/路径），收到事件后的回调函数</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">WatchedEvent</span> watchedEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>watchedEvent<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; :: &quot;</span> <span class="token operator">+</span> watchedEvent<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 再次监听</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> child <span class="token operator">:</span> zooKeeper<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;child: &quot;</span> <span class="token operator">+</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KeeperException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="创建节点" tabindex="-1"><a class="header-anchor" href="#创建节点" aria-hidden="true">#</a> 创建节点</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * 创建节点
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 参数 1：要创建的节点的路径；参数 2：节点数据 ；参数 3：节点权限 ；参数 4：节点的类型</span>
        zooKeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;/node01&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;server01&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span><span class="token constant">OPEN_ACL_UNSAFE</span><span class="token punctuation">,</span>
                <span class="token class-name">CreateMode</span><span class="token punctuation">.</span><span class="token constant">PERSISTENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="监听子节点变化" tabindex="-1"><a class="header-anchor" href="#监听子节点变化" aria-hidden="true">#</a> 监听子节点变化</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * 获取子节点并监听节点变化
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testGetChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> children <span class="token operator">=</span> zooKeeper<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> child <span class="token operator">:</span> children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="判断节点是否存在" tabindex="-1"><a class="header-anchor" href="#判断节点是否存在" aria-hidden="true">#</a> 判断节点是否存在</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * 判断节点是否存在
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testExists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Stat</span> stat <span class="token operator">=</span> zooKeeper<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token string">&quot;/node01&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>stat <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;not exist&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;exist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="客户端向服务端写数据流程" tabindex="-1"><a class="header-anchor" href="#客户端向服务端写数据流程" aria-hidden="true">#</a> 客户端向服务端写数据流程</h2><h3 id="写入请求直接发送给leader节点" tabindex="-1"><a class="header-anchor" href="#写入请求直接发送给leader节点" aria-hidden="true">#</a> 写入请求直接发送给Leader节点</h3><p>客户端请求 leader，leader 自己写数据并发送数据给 follower，follower 写数据完成，发送 ack 给leader，此时写入数据的机器已经超过半数，leader 发送 ack 给 Client，之后 leader 再写数据给其他 follower。</p><figure><img src="/assets/image-20220928110608916-84952822.png" alt="image-20220928110608916" tabindex="0" loading="lazy"><figcaption>image-20220928110608916</figcaption></figure><h3 id="写入请求发送给follower节点" tabindex="-1"><a class="header-anchor" href="#写入请求发送给follower节点" aria-hidden="true">#</a> 写入请求发送给follower节点</h3><p>客户端请求 follower，follower 没有写的权限，将请求发送给 leader，leader 自己写数据完成，并写数据给 follower，follower 写数据完成，发送 ack 给 leader，此时 leader 判断写入数据的机器已经超过半数，leader 发送 ack 给 follower（follower 和 Client 建立连接），之后 leader 再写数据给其他 follower。</p><figure><img src="/assets/image-20220928110637290-85bb804c.png" alt="image-20220928110637290" tabindex="0" loading="lazy"><figcaption>image-20220928110637290</figcaption></figure><h2 id="服务器动态上下线监听案例" tabindex="-1"><a class="header-anchor" href="#服务器动态上下线监听案例" aria-hidden="true">#</a> 服务器动态上下线监听案例</h2><p>要求：某分布式系统中，主节点可以有多台，可以动态上下线，任意一台客户端都能实时感知到主节点服务器的上下线。</p><figure><img src="/assets/image-20220928111752756-d3c745d3.png" alt="image-20220928111752756" tabindex="0" loading="lazy"><figcaption>image-20220928111752756</figcaption></figure><h3 id="服务端注册" tabindex="-1"><a class="header-anchor" href="#服务端注册" aria-hidden="true">#</a> 服务端注册</h3><p>在集群上创建 /servers 节点</p><p><strong>注意删除时，要写全路径。</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">8</span><span class="token punctuation">]</span> create /servers <span class="token string">&quot;servers&quot;</span>
Created /servers
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">9</span><span class="token punctuation">]</span> <span class="token function">ls</span> /
<span class="token punctuation">[</span>servers, zookeeper<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>代码实现：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span>watchdemo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WatchOnOffLineServer</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">ZooKeeper</span> zooKeeper <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> connectString <span class="token operator">=</span> <span class="token string">&quot;192.168.100.100:2181,192.168.100.110:2181,192.168.100.120:2181&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> sessionTimeout <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> parentNode <span class="token operator">=</span> <span class="token string">&quot;/servers&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hostnameArray <span class="token operator">=</span> args<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> args <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">&quot;192.168.100.100&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;192.168.100.110&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">WatchOnOffLineServer</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WatchOnOffLineServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        server<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> hostname <span class="token operator">:</span> hostnameArray<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            server<span class="token punctuation">.</span><span class="token function">registServer</span><span class="token punctuation">(</span>hostname<span class="token punctuation">)</span><span class="token punctuation">;</span>
            server<span class="token punctuation">.</span><span class="token function">business</span><span class="token punctuation">(</span>hostname<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">business</span><span class="token punctuation">(</span><span class="token class-name">String</span> hostname<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hostname <span class="token operator">+</span> <span class="token string">&quot; is working ...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 向Zookeeper注册服务器信息，数据为$<span class="token punctuation">{</span>hostname<span class="token punctuation">}</span>
     * <span class="token keyword">@param</span> <span class="token parameter">hostname</span>
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">InterruptedException</span></span>
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">KeeperException</span></span>
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">registServer</span><span class="token punctuation">(</span><span class="token class-name">String</span> hostname<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">KeeperException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> created <span class="token operator">=</span> zooKeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>
                parentNode <span class="token operator">+</span> <span class="token string">&quot;/server&quot;</span><span class="token punctuation">,</span>
                hostname<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span><span class="token constant">OPEN_ACL_UNSAFE</span><span class="token punctuation">,</span> <span class="token class-name">CreateMode</span><span class="token punctuation">.</span><span class="token constant">PERSISTENT_SEQUENTIAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hostname <span class="token operator">+</span> <span class="token string">&quot; online ...&quot;</span> <span class="token operator">+</span> created<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        zooKeeper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span>connectString<span class="token punctuation">,</span> sessionTimeout<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">WatchedEvent</span> watchedEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="客户端监听" tabindex="-1"><a class="header-anchor" href="#客户端监听" aria-hidden="true">#</a> 客户端监听</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>package com.example.zookeeper.watchdemo<span class="token punctuation">;</span>

<span class="token function">import</span> org.apache.zookeeper.*<span class="token punctuation">;</span>

<span class="token function">import</span> java.io.IOException<span class="token punctuation">;</span>
<span class="token function">import</span> java.nio.charset.StandardCharsets<span class="token punctuation">;</span>
<span class="token function">import</span> java.util.ArrayList<span class="token punctuation">;</span>
<span class="token function">import</span> java.util.List<span class="token punctuation">;</span>
<span class="token function">import</span> java.util.stream.Collectors<span class="token punctuation">;</span>

public class WatchOnOffLineClient <span class="token punctuation">{</span>
    private ZooKeeper zooKeeper <span class="token operator">=</span> null<span class="token punctuation">;</span>
    private String connectString <span class="token operator">=</span> <span class="token string">&quot;192.168.100.100:2181,192.168.100.110:2181,192.168.100.120:2181&quot;</span><span class="token punctuation">;</span>
    private static int sessionTimeout <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">;</span>
    private String parentNode <span class="token operator">=</span> <span class="token string">&quot;/servers&quot;</span><span class="token punctuation">;</span>

    public static void main<span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> throws Exception <span class="token punctuation">{</span>
        WatchOnOffLineClient client <span class="token operator">=</span> new WatchOnOffLineClient<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client.getConnection<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client.getServerList<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client.business<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    private void getConnection<span class="token punctuation">(</span><span class="token punctuation">)</span> throws IOException <span class="token punctuation">{</span>
        zooKeeper <span class="token operator">=</span> new ZooKeeper<span class="token punctuation">(</span>connectString, sessionTimeout, new <span class="token function-name function">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            @Override
            public void process<span class="token punctuation">(</span>WatchedEvent watchedEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                try <span class="token punctuation">{</span>
                    getServerList<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    private void getServerList<span class="token punctuation">(</span><span class="token punctuation">)</span> throws InterruptedException, KeeperException <span class="token punctuation">{</span>
        List<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> children <span class="token operator">=</span> zooKeeper.getChildren<span class="token punctuation">(</span>parentNode, <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        // 存储服务器信息列表
        List<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> servers <span class="token operator">=</span> new ArrayList<span class="token operator">&lt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        // 遍历所有节点，获取节点中的主机名称信息
        <span class="token keyword">for</span> <span class="token punctuation">(</span>String child <span class="token builtin class-name">:</span> children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            byte<span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> zooKeeper.getData<span class="token punctuation">(</span>parentNode + <span class="token string">&quot;/&quot;</span> + child, false, null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            servers.add<span class="token punctuation">(</span>new String<span class="token punctuation">(</span>data, StandardCharsets.UTF_8<span class="token punctuation">))</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        System.out.println<span class="token punctuation">(</span><span class="token string">&quot;servers: &quot;</span> + servers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    private void business<span class="token punctuation">(</span><span class="token punctuation">)</span> throws IOException <span class="token punctuation">{</span>
        System.out.println<span class="token punctuation">(</span><span class="token string">&quot;client is working ...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System.in.read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="zookeeper-分布式锁实现" tabindex="-1"><a class="header-anchor" href="#zookeeper-分布式锁实现" aria-hidden="true">#</a> ZooKeeper 分布式锁实现</h1><h2 id="实现过程" tabindex="-1"><a class="header-anchor" href="#实现过程" aria-hidden="true">#</a> 实现过程</h2><p>分布式锁：分布式系统中多个进程能够有序访问临界资源的锁即为分布式锁。</p><figure><img src="/assets/image-20221009235930879-7d23d69d.png" alt="image-20221009235930879" tabindex="0" loading="lazy"><figcaption>image-20221009235930879</figcaption></figure><p>通过创建有序的临时节点实现分布式锁，该节点作为分布式锁。</p><p>客户端判断获取到的节点是否为最小节点，如果是则该节点作为锁，，如果不是，则监听上一个节点，对于每一个节点，处理完业务后，需要释放锁，其他的节点得到锁。</p><h2 id="原生zookeeper实现分布式锁" tabindex="-1"><a class="header-anchor" href="#原生zookeeper实现分布式锁" aria-hidden="true">#</a> 原生Zookeeper实现分布式锁</h2><p>分布式锁：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span>lock</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span>data<span class="token punctuation">.</span></span><span class="token class-name">Stat</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">CountDownLatch</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DistributedLock</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> connectString <span class="token operator">=</span> <span class="token string">&quot;192.168.100.100:2181,192.168.100.110:2181,192.168.100.120:2181&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// 注意，该值在确保网络，防火墙关闭的情况下，值应该设置大一点</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> sessionTimeout <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ZooKeeper</span> zooKeeper <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> rootNode <span class="token operator">=</span> <span class="token string">&quot;/locks&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> subNodePrefix <span class="token operator">=</span> <span class="token string">&quot;/seq-&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">CountDownLatch</span> connectLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">CountDownLatch</span> waitLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> currentNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> waitNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 创建节点
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">DistributedLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">KeeperException</span> <span class="token punctuation">{</span>
        zooKeeper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span>connectString<span class="token punctuation">,</span> sessionTimeout<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">WatchedEvent</span> watchedEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 监听连接事件</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>watchedEvent<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Event<span class="token punctuation">.</span>KeeperState<span class="token punctuation">.</span>SyncConnected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    connectLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 监听上一个节点</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>watchedEvent<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Event<span class="token punctuation">.</span>EventType<span class="token punctuation">.</span>NodeDeleted</span> <span class="token operator">&amp;&amp;</span> watchedEvent<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>waitNode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    waitLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 等待连接完成，创建节点</span>
        connectLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 判断节点是否存在</span>
        <span class="token class-name">Stat</span> exists <span class="token operator">=</span> zooKeeper<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>rootNode<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>exists <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            zooKeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>rootNode<span class="token punctuation">,</span> rootNode<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span><span class="token constant">OPEN_ACL_UNSAFE</span><span class="token punctuation">,</span> <span class="token class-name">CreateMode</span><span class="token punctuation">.</span><span class="token constant">PERSISTENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 加锁：即创建临时有序的子节点，如果有多个，则排序等待前一个释放锁
     * 释放锁：删除该子节点
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">zkLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">KeeperException</span> <span class="token punctuation">{</span>
        currentNode <span class="token operator">=</span> zooKeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>rootNode <span class="token operator">+</span> subNodePrefix<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span><span class="token constant">OPEN_ACL_UNSAFE</span><span class="token punctuation">,</span> <span class="token class-name">CreateMode</span><span class="token punctuation">.</span><span class="token constant">EPHEMERAL_SEQUENTIAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 方便测试</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> children <span class="token operator">=</span> zooKeeper<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span>rootNode<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>children<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> thisNode <span class="token operator">=</span> currentNode<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>rootNode<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;thisNode: &quot;</span> <span class="token operator">+</span> thisNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> index <span class="token operator">=</span> children<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>thisNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;数据异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                waitNode <span class="token operator">=</span> rootNode <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> children<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;waitNode: &quot;</span> <span class="token operator">+</span> waitNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
                zooKeeper<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span>waitNode<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Stat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                waitLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 解锁
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">zkUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 删除节点，设置版本</span>
            zooKeeper<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentNode<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> <span class="token operator">|</span> <span class="token class-name">KeeperException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试分布式锁：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span>lock</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span></span><span class="token class-name">KeeperException</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DistributedLockTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">KeeperException</span> <span class="token punctuation">{</span>
        <span class="token class-name">DistributedLock</span> distributedLock01 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DistributedLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DistributedLock</span> distributedLock02 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DistributedLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    distributedLock01<span class="token punctuation">.</span><span class="token function">zkLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Thread01 上锁...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    distributedLock01<span class="token punctuation">.</span><span class="token function">zkUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Thread01 解锁...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> <span class="token operator">|</span> <span class="token class-name">KeeperException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Thread01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    distributedLock02<span class="token punctuation">.</span><span class="token function">zkLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Thread02 上锁...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    distributedLock02<span class="token punctuation">.</span><span class="token function">zkUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Thread02 解锁...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> <span class="token operator">|</span> <span class="token class-name">KeeperException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Thread02&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试结果：</p><p>Thread02 上锁...</p><p>Thread02 解锁...</p><p>Thread01 上锁...</p><p>Thread01 解锁...</p><h2 id="curator-框架实现分布式锁" tabindex="-1"><a class="header-anchor" href="#curator-框架实现分布式锁" aria-hidden="true">#</a> Curator 框架实现分布式锁</h2><h3 id="原生的-java-api-开发存在的问题" tabindex="-1"><a class="header-anchor" href="#原生的-java-api-开发存在的问题" aria-hidden="true">#</a> 原生的 Java API 开发存在的问题</h3><p>（1）会话连接是异步的，需要自己去处理。比如使用 CountDownLatch</p><p>（2）Watch 需要重复注册，不然就不能生效</p><p>（3）开发的复杂性还是比较高的</p><p>（4）不支持多节点删除和创建。需要自己去递归</p><blockquote><p>Curator 是一个专门解决分布式锁的框架，解决了原生 JavaAPI 开发分布式遇到的问题。</p><p>详情请查看官方文档：<a href="https://curator.apache.org/index.html" target="_blank" rel="noopener noreferrer">https://curator.apache.org/index.html<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><h3 id="curator-示例" tabindex="-1"><a class="header-anchor" href="#curator-示例" aria-hidden="true">#</a> Curator 示例</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span>lock</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>framework<span class="token punctuation">.</span></span><span class="token class-name">CuratorFramework</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>framework<span class="token punctuation">.</span></span><span class="token class-name">CuratorFrameworkFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>recipes<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">InterProcessMutex</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>retry<span class="token punctuation">.</span></span><span class="token class-name">ExponentialBackoffRetry</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CuratorLockTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建分布式锁1</span>
        <span class="token class-name">InterProcessMutex</span> lock1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InterProcessMutex</span><span class="token punctuation">(</span><span class="token function">getCuratorFramework</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;/locks&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建分布式锁2</span>
        <span class="token class-name">InterProcessMutex</span> lock2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InterProcessMutex</span><span class="token punctuation">(</span><span class="token function">getCuratorFramework</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;/locks&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    lock1<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程1 获取到锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    lock1<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程1 再次获取到锁(可重入锁)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    lock1<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程1 释放锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    lock1<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程1 再次释放锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    lock2<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程2 获取到锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    lock2<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程2 再次获取到锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    lock2<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程2 释放锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    lock2<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程2  再次释放锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">CuratorFramework</span> <span class="token function">getCuratorFramework</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 3秒连接不上重试</span>
        <span class="token class-name">ExponentialBackoffRetry</span> policy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExponentialBackoffRetry</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CuratorFramework</span> client <span class="token operator">=</span> <span class="token class-name">CuratorFrameworkFactory</span>
                <span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">connectString</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.100.100:2181,192.168.100.110:2181,192.168.100.120:2181&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">connectionTimeoutMs</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">sessionTimeoutMs</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">retryPolicy</span><span class="token punctuation">(</span>policy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动客户端</span>
        client<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;zookeeper 启动成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> client<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试结果：</p><p>线程2 获取到锁<br> 线程2 再次获取到锁<br> 线程2 释放锁<br> 线程2 再次释放锁<br> 线程1 获取到锁<br> 线程1 再次获取到锁(可重入锁)<br> 线程1 释放锁<br> 线程1 再次释放锁</p><h1 id="两个问题" tabindex="-1"><a class="header-anchor" href="#两个问题" aria-hidden="true">#</a> 两个问题</h1><h2 id="选举机制-1" tabindex="-1"><a class="header-anchor" href="#选举机制-1" aria-hidden="true">#</a> 选举机制</h2><p>半数机制，超过半数的投票通过，即通过。</p><p>（1）第一次启动选举规则： 投票过半数时，服务器 id 大的胜出</p><p>（2）第二次启动选举规则：</p><ul><li>​ EPOCH 大的直接胜出</li><li>​ EPOCH 相同，事务 id 大的胜出</li><li>​ 事务 id 相同，服务器 id 大的胜出</li></ul><h2 id="生产集群安装多少-zk-合适" tabindex="-1"><a class="header-anchor" href="#生产集群安装多少-zk-合适" aria-hidden="true">#</a> 生产集群安装多少 zk 合适？</h2><p>安装奇数台。</p><p>生产经验：</p><p>10 台服务器：3 台 zk；</p><p>20 台服务器：5 台 zk；</p><p>100 台服务器：11 台 zk；</p><p>200 台服务器：11 台 zk ；</p><p><strong>服务器台数多：好处，提高可靠性；坏处：提高通信延时</strong></p><h1 id="源码分析" tabindex="-1"><a class="header-anchor" href="#源码分析" aria-hidden="true">#</a> 源码分析</h1><h2 id="zookeeper-是如何保证数据一致性的" tabindex="-1"><a class="header-anchor" href="#zookeeper-是如何保证数据一致性的" aria-hidden="true">#</a> Zookeeper 是如何保证数据一致性的？</h2></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/vuepress-theme-hope/vuepress-theme-hope/edit/main/src/Java/Zookeeper.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page on GitHub" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->Edit this page on GitHub<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><!----><!----></div></footer><nav class="vp-page-nav"><a class="vp-link nav-link prev" href="/Java/Redis.html"><div class="hint"><span class="arrow start"></span>Prev</div><div class="link"><!---->/Java/Redis.md</div></a><a class="vp-link nav-link next" href="/Java/Nginx.html"><div class="hint">Next<span class="arrow end"></span></div><div class="link">Nginx<!----></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><!----><div class="vp-copyright">Copyright © 2023 MineTing</div></footer></div><!--]--><!--]--></div>
    <script type="module" src="/assets/app-ae2ce5af.js" defer></script>
  </body>
</html>
